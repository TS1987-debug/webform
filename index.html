<!--
Simple Chatbot HTML (single-file)
Integrated with local Node.js Proxy for Zapier
Proxy URL: http://localhost:3000/chat
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chatbot with Proxy</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --user:#0ea5a4; --bot:#1f2937;
      --radius:14px; --gap:12px; --maxw:760px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; background:linear-gradient(180deg,#071022 0%, #011026 100%); color:#e6eef6}

    .container{width:100%; max-width:var(--maxw); padding:28px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04); border-radius:var(--radius); overflow:hidden; box-shadow:0 6px 30px rgba(2,6,23,0.7)}

    header{display:flex; align-items:center; gap:12px; padding:18px 20px}
    .avatar{width:48px; height:48px; border-radius:10px; background:linear-gradient(135deg,var(--accent), #7c3aed); display:flex; align-items:center; justify-content:center; font-weight:700}
    header h1{font-size:18px; margin:0}
    header p{margin:0; color:var(--muted); font-size:13px}

    .history{height:520px; padding:18px; overflow:auto; display:flex; flex-direction:column; gap:var(--gap); background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);}

    .message{display:flex; gap:10px; max-width:80%;}
    .message .bubble{padding:12px 14px; border-radius:12px; font-size:14px; line-height:1.3; box-shadow:0 1px 0 rgba(255,255,255,0.02) inset}

    .msg-bot{align-self:flex-start;}
    .msg-bot .bubble{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); color:#e6eef6; border-radius:12px 12px 12px 4px}

    .msg-user{align-self:flex-end; flex-direction:row-reverse}
    .msg-user .bubble{background:var(--user); color:#012; border-radius:12px 12px 4px 12px}

    .meta{font-size:11px; color:var(--muted); margin-top:6px}

    .composer{display:flex; gap:12px; padding:14px; border-top:1px solid rgba(255,255,255,0.02); align-items:flex-end}
    .input{flex:1; display:flex; flex-direction:column}
    textarea{width:100%; min-height:48px; max-height:160px; resize:none; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; outline:none}
    .controls{display:flex; gap:8px; align-items:center}
    button.send{background:linear-gradient(90deg,var(--accent), #7c3aed); border:none; color:#022; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer}
    button.send:disabled{opacity:0.5; cursor:not-allowed}

    .quick{display:flex; gap:8px; flex-wrap:wrap; padding:10px 18px 0}
    .chip{background:rgba(255,255,255,0.03); color:var(--muted); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px}

    .typing{font-size:13px; color:var(--muted); display:inline-block}

    @media (max-width:640px){ .history{height:60vh} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card" role="application" aria-label="Chatbot">
      <header>
        <div class="avatar">CB</div>
        <div>
          <h1>Chatbot via Proxy</h1>
          <p>Messages are sent to your local Node.js proxy which forwards to Zapier.</p>
        </div>
      </header>

      <div id="history" class="history" aria-live="polite"></div>

      <div class="quick" id="quick">
        <div class="chip" data-text="Hello">Hello</div>
        <div class="chip" data-text="Show bookings">Show bookings</div>
        <div class="chip" data-text="Cancel appointment">Cancel appointment</div>
      </div>

      <div class="composer">
        <div class="input">
          <textarea id="input" placeholder="Write a message... (Enter to send, Shift+Enter for newline)"></textarea>
          <div class="meta" id="status"></div>
        </div>
        <div class="controls">
          <button id="send" class="send">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const historyEl = document.getElementById('history');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const quick = document.getElementById('quick');

    function timestamp(){
      const d = new Date();
      return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function appendMessage(role, text, time){
      const wrapper = document.createElement('div');
      wrapper.className = 'message ' + (role === 'user' ? 'msg-user' : 'msg-bot');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      wrapper.appendChild(bubble);
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = time || timestamp();
      wrapper.appendChild(meta);
      historyEl.appendChild(wrapper);
      historyEl.scrollTop = historyEl.scrollHeight - historyEl.clientHeight + 100;
    }

    function setStatus(text){ statusEl.textContent = text; }

    async function sendToServer(message){
      try {
        const resp = await fetch('http://localhost:3000/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const text = await resp.text();
        try {
          const data = JSON.parse(text);
          return data.reply || JSON.stringify(data) || '✅ Message sent via proxy!';
        } catch {
          return text || '✅ Message sent via proxy!';
        }
      } catch (err) {
        console.error(err);
        return '❌ Error sending message via proxy. Check server log.';
      }
    }

    let sending = false;
    async function sendMessage(){
      const text = inputEl.value.trim();
      if(!text || sending) return;
      appendMessage('user', text);
      inputEl.value = '';
      setStatus('Sending...');
      sending = true;
      sendBtn.disabled = true;

      const typingNode = document.createElement('div');
      typingNode.className = 'message msg-bot';
      typingNode.innerHTML = `<div class="bubble"><span class="typing">Typing...</span></div>`;
      historyEl.appendChild(typingNode);
      historyEl.scrollTop = historyEl.scrollHeight;

      try {
        const reply = await sendToServer(text);
        historyEl.removeChild(typingNode);
        appendMessage('bot', reply);
        setStatus('');
      } catch(err) {
        historyEl.removeChild(typingNode);
        appendMessage('bot', 'Error: Unable to send message.');
        setStatus('Error');
      } finally {
        sending = false;
        sendBtn.disabled = false;
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    quick.addEventListener('click', (e)=>{
      const chip = e.target.closest('.chip');
      if(!chip) return;
      inputEl.value = chip.dataset.text;
      inputEl.focus();
    });

    appendMessage('bot', 'Hello! I\'m connected via your local proxy. Type a message to test.');
    inputEl.focus();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Two-way Chatbot with Zapier + Polling</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-gradient-to-br from-blue-100 via-indigo-100 to-blue-50 min-h-screen flex flex-col font-sans">
 
  <!-- Chatbot Icon -->
<div id="chatbot-icon"
       class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full flex items-center justify-center text-white text-3xl cursor-pointer shadow-2xl hover:scale-110 transition-transform duration-300 ease-out">
    üí¨
</div>
 
  <!-- Chat Window -->
<div id="chat-window"
       class="fixed bottom-28 right-6 w-96 h-[32rem] bg-white border border-gray-200 rounded-3xl shadow-2xl hidden flex-col overflow-hidden animate__animated animate__fadeInUp">
 
    <!-- Header -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-4 text-lg font-semibold flex justify-between items-center shadow">
<span>Chatbot Assistant ü§ñ</span>
<button id="close-btn" class="text-white text-2xl font-bold hover:text-gray-200 transition">&times;</button>
</div>
 
    <!-- Messages -->
<div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 p-5 bg-gray-50"></div>
 
    <!-- Input -->
<div class="p-4 border-t border-gray-200 flex space-x-2 bg-gray-100">
<input type="text" id="user-message" placeholder="Type your message..."
             class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-400 shadow-sm"/>
<button id="send-btn"
              class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-2 rounded-xl hover:opacity-90 transition-all shadow-md">
        Send
</button>
</div>
</div>
 
  <script>
    const corsProxy = "https://cors-anywhere.herokuapp.com/";
    const webhookUrl = "https://hooks.zapier.com/hooks/catch/24917788/u537s8d/";
    const pollingApiUrl = "https://api.sheetbest.com/sheets/dafde53d-1023-4d7b-b93c-9a03ec35d29d";
 
    const icon = document.getElementById('chatbot-icon');
    const windowBox = document.getElementById('chat-window');
    const closeBtn = document.getElementById('close-btn');
    const messages = document.getElementById('chat-messages');
    const input = document.getElementById('user-message');
    const sendBtn = document.getElementById('send-btn');
 
    let pollInterval = null;
 
    icon.addEventListener('click', () => windowBox.style.display = "flex");
    closeBtn.addEventListener("click", () => windowBox.style.display = "none");
    document.addEventListener("click", e => {
      if (!windowBox.contains(e.target) && !icon.contains(e.target)) windowBox.style.display = "none";
    });
 
    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => { if (e.key === "Enter") sendMessage(); });
 
    function generateUUID() {
      return 'sess-xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
 
    async function sendMessage() {
      const userText = input.value.trim();
      if (!userText) return;
 
      addBubble("You", userText, "bg-blue-600 text-white ml-auto");
      input.value = "";
 
      const sessionId = generateUUID(); // Unique for each message
 
      // Show "Checking..." bubble and keep its ID
      const checkingBubbleId = addBubble("Bot", "Checking...", "bg-yellow-100 text-yellow-800 mr-auto");
 
      try {
        await fetch(corsProxy + webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sessionId: sessionId,
            userMessage: userText,
            botReply: "",
            timestamp: new Date().toISOString()
          })
        });
 
        startPolling(sessionId, checkingBubbleId);
 
      } catch (err) {
        console.error(err);
        updateBubble(checkingBubbleId, "‚ö†Ô∏è Error sending message.", "bg-red-100 text-red-900");
      }
    }
 
    function startPolling(sessionId, checkingBubbleId) {
      if (pollInterval) clearInterval(pollInterval);
 
      pollInterval = setInterval(async () => {
        try {
          const res = await fetch(pollingApiUrl);
          if (!res.ok) throw new Error('Network response not ok');
 
          const data = await res.json();
          console.log("Polling API response:", data);
 
          const sessionReplies = data.filter(item =>
            item.sessionId === sessionId &&
            item.botReply &&
            item.botReply.trim() !== ""
          );
 
          if (sessionReplies.length > 0) {
            const latestReply = sessionReplies[sessionReplies.length - 1].botReply;
            updateBubble(checkingBubbleId, latestReply, "bg-gray-200 text-gray-800");
            clearInterval(pollInterval);
          }
        } catch (err) {
          console.error('Polling error:', err);
          updateBubble(checkingBubbleId, "‚ö†Ô∏è Error getting response.", "bg-red-100 text-red-900");
          clearInterval(pollInterval);
        }
      }, 3000);
    }
 
    function addBubble(sender, text, cls) {
      const row = document.createElement("div");
      row.className = `flex ${sender === "You" ? "justify-end" : "justify-start"}`;
      const b = document.createElement("div");
      b.className = `max-w-[75%] px-4 py-2 rounded-2xl text-base shadow ${cls}`;
      b.textContent = text;
      row.appendChild(b);
      messages.appendChild(row);
      messages.scrollTop = messages.scrollHeight;
 
      const bubbleId = "bubble_" + Date.now() + "_" + Math.floor(Math.random() * 1000);
      row.setAttribute("id", bubbleId);
      return bubbleId;
    }
 
    function updateBubble(bubbleId, newText, newClass) {
      const bubble = document.getElementById(bubbleId)?.firstChild;
      if (bubble) {
        bubble.textContent = newText;
        bubble.className = `max-w-[75%] px-4 py-2 rounded-2xl text-base shadow ${newClass}`;
      }
    }
</script>
</body>
</html>
